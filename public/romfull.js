var names=["1.png","5.png","161.png","162.png","163.png","164.png","269.png","338.png","blue_orb.png"],blocks=[],rendered=[],sblocks=[],enemies=[],spikesr=[],spikesl=[],spikesu=[],spikesd=[],imgs=[],sel,mr,ep,sp;function preload(){for(var t=0;t<names.length;t++)imgs[t]=loadImage("./res/original/"+names[t],"png")}function setup(){createCanvas(850,600).parent("lmaker"),curse()}function draw(){background(99,99,190),rect(50,0,800,600),rect(0,0,50,600);for(var t=0;t<names.length;t++){var e=imgs[t],i=names[t];image(e,10,10+50*t),mr&&mouseX<50&&mouseX<10+e.width/2&&mouseX>10&&mouseY>10+50*t-e.height/2&&mouseY<10+50*t+e.height/2&&((sel=e).name=i)}curse();for(t=0;t<rendered.length;t++)rendered[t].drwbx();mr=!1}function mouseReleased(){mr=!0}function curse(){if(null!=sel){var t=sel;image(t,mouseX,mouseY),mr&&mouseX>50&&(savedt(),rendered.push(new renderbox(mouseX,mouseY,t)))}else fill(205,0,0),rect(mouseX,mouseY,32,32),fill(255)}function savedt(){"1.png"==sel.name?sp="{ x:"+mouseX+", y: "+mouseY+" }":"blue_orb.png"==sel.name?ep="{ x:"+mouseX+", y: "+mouseY+" }":"5.png"==sel.name?blocks.push("{ x:"+mouseX+", y: "+mouseY+" }"):"161.png"==sel.name?spikesu.push("{ x:"+mouseX+", y: "+mouseY+" }"):"162.png"==sel.name?spikesr.push("{ x:"+mouseX+", y: "+mouseY+" }"):"163.png"==sel.name?spikesl.push("{ x:"+mouseX+", y: "+mouseY+" }"):"164.png"==sel.name?spikesd.push("{ x:"+mouseX+", y: "+mouseY+" }"):"269.png"==sel.name?enemies.push("{ x:"+mouseX+", y: "+mouseY+" }"):"338.png"==sel.name&&sblocks.push("{ x:"+mouseX+", y: "+mouseY+" }")}function renderbox(t,e,i){this.x=t,this.y=e,this.v=i,this.drwbx=function(){image(this.v,float(this.x),float(this.y))}}var ro=!0;function sendData(){if(null!=ep[0]&&null!=sp[0]&&ro){var t={strt:sp,end:ep,blk:blocks,sblk:sblocks,enem:enemies,slft:spikesl,srt:spikesr,su:spikesu,sd:spikesd},e=JSON.stringify(t),i=new XMLHttpRequest;i.addEventListener("load",handledt),i.open("POST","submit"),i.setRequestHeader("Content-Type","application/json"),i.send(e)}else alert("please set player and end portal position");ro=!1}function handledt(){"s"==this.responseText&&location.reload()}function spawnSpike(t){this.spike&&this.spike.timer||(this.spike=t.addObject({image:"spikeUp",killing:!0,x:this.x,y:this.y,tickFunction:moveHiddenSpike,zIndex:-1}),this.spike.timer=64)}function moveHiddenSpike(t){this.timer?(this.y+=Math.rectangle(64)(this.timer),this.timer--):t.removeObject(this)}function startObject(t){return function(e){var i=e.objectMap[t];i.active=!0,i.timer=0,e.removeObject(this)}}function badPlatform(t){t.removeObject(this)}function transitionUp(t){600===t.viewportY&&(t.viewportY=0)}function transitionDown(t){0===t.viewportY&&(t.viewportY=600)}function additionalJump(t){t.canJump=!0,t.removeObject(this),t.audio.play("Mega_Man_Blast_Sound.ogg")}function moveApple(t){this.y+=Math.rectangle(100)(t.tickCount)}function redOrb(t){t.addObject({tickFunction:shake}).timer=0,t.removeObject(this)}function shake(t){this.timer%4==2?t.viewportY-=2:this.timer%4==0&&(t.viewportY+=2),this.timer%10==0&&(t.objectMap.exitBlock.y--,t.objectMap.exitSpike.y--),this.timer++,this.timer>1500&&t.removeObject(this)}function tickFunction(t){}function nextLevel(t){clevel=parseInt(clevel)+1,localStorage.setItem("clev",clevel),document.getElementById("stg").src="./levels/tf/"+clevel+".js",console.log("lchange: "+clevel),t.nextLevel("level1.js"),t.removeObject(this),location.reload()}function loadState(t,e){12513007===e?(t.posY=224,t.posX=37,t.viewportY=0,t.removeObjectById("saveState1")):console.log("invalid state: "+e)}function saveState1(t){t.saveState(12513007),t.removeObject(this),t.audio.play("Mega_Man_Beam_Sound.ogg",!1,!1)}var template={resourceDir:"res/original/",musicDir:"res/music/",startViewport:{x:0,y:0},width:900,height:1360,characterWidth:25,characterHeight:21,backgroundMusic:"Fire_Man_Stage.ogg",deathMusic:"28.ogg",jumpMusic1:"jump1.ogg",jumpMusic2:"jump2.ogg",loadState:loadState,init:function(t){},physics:{jumpInitialSpeed:-5,jumpGravity:.15,jumpTicks:100,fallSpeedCap:4.5,fallGravity:.3,moveSpeed:2,timePerTick:12},backgroundColor:"#fff",images:{gameOver:"309.png",1:"338.png",3:"5.png",apple:"269.png",charR1:"1.png",charR2:"2.png",charR3:"3.png",charR4:"4.png",charL1:"18.png",charL2:"19.png",charL3:"20.png",charL4:"21.png",charMR1:"250.png",charMR2:"247.png",charMR3:"251.png",charMR4:"249.png",charMR5:"252.png",charMR6:"250.png",charML1:"255.png",charML2:"248.png",charML3:"256.png",charML4:"248.png",charML5:"257.png",charML6:"255.png",charFR1:"14.png",charFR2:"15.png",charFL1:"17.png",charFL2:"16.png",charJumpingLeft:"7.png",charJumpingRight:"12.png",charHitmap:"char_hitmap.png",spikeUp:"161.png",spikeLeft:"163.png",spikeRight:"162.png",spikeDown:"164.png",blueOrb:"blue_orb.png"},animations:{charFallingLeft:{time:2,images:["charFL1","charFL2"]},charFallingRight:{time:2,images:["charFR1","charFR2"]},charRight:{time:6,images:["charR1","charR2","charR3","charR4"]},charLeft:{time:6,images:["charL1","charL2","charL3"]},charMovingRight:{time:2,images:["charMR1","charMR2","charMR3","charMR4","charMR5","charMR6"]},charMovingLeft:{time:2,images:["charML1","charML2","charML3","charML4","charML5","charML6"]}},tickFunction:tickFunction};function GameStorage(t){this.works=!0,this.tempStorage={};try{if(!localStorage.getItem("version")&&(localStorage.setItem("version",t),!localStorage.getItem("version")))throw"grenade"}catch(t){this.works=!1}this.works?Number(localStorage.getItem("version"))!==t&&(localStorage.clear(),console.log("Storage cleared because of game update to version "+t)):this.setItem("version",t)}GameStorage.prototype.setItem=function(t,e){e=JSON.stringify(e),this.works?localStorage.setItem(t,e):this.tempStorage[t]=e},GameStorage.prototype.removeItem=function(t){this.works?localStorage.removeItem(t):delete this.tempStorage[t]},GameStorage.prototype.getItem=function(t){return this.works?JSON.parse(localStorage.getItem(t)):this.tempStorage[t]?JSON.parse(this.tempStorage[t]):null},Object.deepcopy=function(t){var e,i={},n={},a=[];t=function t(e,o,s,r){var h;if("object"==typeof e){if(null==e)return e;for(h in i)if(i[h]===e)return a.push({resolveTo:h,child:s,i:r}),null;i[o]=e,Object.isArray(e)?s=[]:(s={}).__proto__=e.__proto__;for(h in e)s[h]=t(e[h],o+"["+h+"]",s,h);n[o]=s}else s=e;return s}(t,"*");for(e in a){var o=a[e];o&&o.child&&o.i in o.child&&(o.child[o.i]=n[o.resolveTo])}return t};var DEBUG=!0,RIGHT=0,LEFT=1,NOT_FALLING=0,IN_JUMP=1,FALLING=2,GAME_WIDTH=800,GAME_HEIGHT=600,FIRST_LEVEL="level1.js",LEVEL_DIR="levels/",STORAGE_NO_AUDIO="no_audio",STORAGE_LEVEL="last_level",STORAGE_STATE="state";function GameEngine(){this.version=.02,this.width=GAME_WIDTH,this.height=GAME_HEIGHT,this.storage=new GameStorage(this.version),this.storage.works||dbg_warn("localStorage not supported. Your game will not be saved."),this.keyboard=new KeyboardManager(this),this.renderer=new GameRenderer(this),this.audio=new AudioManager(!this.storage.getItem(STORAGE_NO_AUDIO)),this.audio.works||dbg_warn("Your browser does not support HTML5 audio or ogg/vorbis"),this.posY=this.posX=this.viewportY=this.viewportX=null,this.lastTick=Date.now(),this.totalDelta=0,this.running=this.drawableObjects=this.blockingObjects=this.triggeringObjects=this.objectMap=this.objects=this.charBitmap=this.vspeed=this.direction=this.canJump=this.fallingState=this.tickCount=null,this.tickFunctionStopped=!0,this.isMoving=null,this.images={},this.drawHooks=this.gameData=null,this.levelFile=this.storage.getItem(STORAGE_LEVEL);var t=this;document.getElementById("mute_button").addEventListener("click",function(){t.toggleMute()},!1),document.getElementById("reset_save").addEventListener("click",function(){localStorage.setItem("clev",1),t.nextLevel(FIRST_LEVEL)},!1),this.levelFile||(this.levelFile=FIRST_LEVEL),this.loadLevel(this.levelFile)}function AudioManager(t){this.muted=!t,this.works=!0,window.Audio&&(new Audio).canPlayType("audio/ogg; codecs=vorbis")||(this.works=!1),this.playing=[],this.playQueue=[]}function Bitmap(t,e){this.width=t,this.height=e,this.count=t*e,this.data=new Uint8Array(this.count)}function Line(t,e,i,n){this.p1={x:t,y:e},this.p2={x:i,y:n},this.width=Math.abs(this.p1.x-this.p2.x)+1,this.height=Math.abs(this.p1.y-this.p2.y)+1,this.bitmap=null}function Rectangle(t,e){this.width=t,this.height=e,this.bitmap=null}function AutoShape(t){this.width=t.width,this.height=t.height,this.image=t,this.bitmap=null}window.addEventListener("load",function(){var t=new GameEngine;DEBUG&&"localhost"===location.host&&window.LevelEditor&&new LevelEditor(t)},!1),GameEngine.prototype.nextLevel=function(t){this.levelFile=t,this.storage.setItem(STORAGE_LEVEL,t),this.storage.removeItem(STORAGE_STATE),this.loadLevel(t)},GameEngine.prototype.loadLevel=function(a){var b=this;this.running=!1,http_get(LEVEL_DIR+a+"?"+Math.random(),function(a){if(a=eval(a),!a)throw"level not found";b.level=a,b.loadResources(a)})},GameEngine.prototype.loadResources=function(t){function e(){return o++,function(){s++,r.renderer.drawLoadingScreen(s,o),o===s&&r.start()}}function i(){throw"loading a resource failed. Will not start"}var n=t.resourceDir,a=Object.keys(t.images),o=0,s=0,r=this;this.audio.path=t.musicDir,this.level=t,this.audio.preload(this.level.jumpMusic1,e(),i),this.audio.preload(this.level.jumpMusic2,e(),i),a.forEach(function(a){var o=t.images[a],s=new Image;r.images[a]=s,s.onload=e(),s.onerror=i,s.src=n+o}),this.renderer.drawLoadingScreen(0,o)},GameEngine.prototype.start=function(){this.charBitmap=Bitmap.fromImage(this.images.charHitmap),this.dead=!1,this.audio.play(this.level.backgroundMusic,!0,!0),this.restart(),this.running=!0,this.tickFunctionStopped&&this.doTick(this)},GameEngine.prototype.restart=function(){this.viewportX=this.level.startViewport.x,this.viewportY=this.level.startViewport.y,this.posX=this.level.startPosition.x,this.posY=this.level.startPosition.y,this.fallingState=FALLING,this.direction=RIGHT,this.canJump=this.isMoving=this.dead=!1,this.vspeed=0,this.audio.stop(this.level.deathMusic),this.tickCount=0,this.gameData={},this.drawHooks=[],this.loadObjects();var t=this.storage.getItem(STORAGE_STATE);t&&this.level.loadState(this,t),this.level.init(this)},GameEngine.prototype.saveState=function(t){this.storage.setItem(STORAGE_STATE,t)},GameEngine.prototype.loadObjects=function(){var t=this,e=Object.deepcopy(this.level.objects);this.objects=[],this.objectMap={},this.triggeringObjects=[],this.blockingObjects=[],this.drawableObjects=[];var i={};(e=e.concatMap(function(t){return cartesianProductOnObjects(t.position,["x","y"]).map(function(e){var i=Object.deepcopy(t);return i.x=e.x,i.y=e.y,i})})).forEach(function(e){(e=t.addObject(e,i)).init&&e.init(t)}),e=this.drawableObjects.partition(function(t){return t.dynamic}),this.drawableObjects=e[0],this.renderer.loadBackground(e[1]),this.renderer.loadForeground([])},GameEngine.prototype.addObject=function(t,e){var i=t.dynamic||!!t.id,n=t.shape,a=t.trigger,o=void 0,s=void 0,r=void 0,h=void 0,c="x y dynamic trigger image blocking killing id tickFunction zIndex position shape retrigger init".split(" ");return e=e||{},Object.keys(t).deleteList(c).length&&(console.log(Object.keys(t).deleteList(c)),dbg_assert(!1,"Unkown properties")),t.image&&(dbg_assert(o=this.images[t.image],"invalid image id"),s=o.width,r=o.height),dbg_assert(!t.blocking||!a,"an object cannot block and have a trigger at the same time"),t.killing&&(dbg_assert(!a,"an object cannot kill and have a trigger at the same time"),dbg_assert(!t.blocking,"an object cannot kill and block at the same time"),a=this.die.bind(this)),void 0===n&&o&&(a||t.blocking||i)&&(e[t.image]?n=e[t.image]:e[t.image]=n=new AutoShape(o)),n&&(s=n.width,r=n.height,h=n.getBitmap()),e={x:t.x,y:t.y,width:s,height:r,dynamic:i,visible:!0,image:o,bitmap:h,trigger:a,zIndex:t.zIndex||0,retrigger:!!t.retrigger,tickFunction:t.tickFunction,init:t.init},a&&(dbg_assert(a instanceof Function,"trigger has to be a function"),dbg_assert(n,"objects that kill or have a trigger require a shape"),this.triggeringObjects.push(e)),t.image&&this.drawableObjects.push(e),t.blocking&&(dbg_assert(n,"objects that block require a shape"),this.blockingObjects.push(e)),this.objects.push(e),t.id&&(dbg_assert(!this.objectMap[t.id],"id used twice"),this.objectMap[t.id]=e),e},GameEngine.prototype.removeObject=function(t){this.objects=this.objects.delete(t),this.blockingObjects=this.blockingObjects.delete(t),this.drawableObjects=this.drawableObjects.delete(t),this.triggeringObjects=this.triggeringObjects.delete(t),t.id&&delete this.objectMap[t.id]},GameEngine.prototype.removeObjectById=function(t){(t=this.objectMap[t])&&this.removeObject(t)},GameEngine.prototype.toggleMute=function(){this.audio.toggleMute(),this.audio.muted?this.storage.setItem(STORAGE_NO_AUDIO,1):this.storage.removeItem(STORAGE_NO_AUDIO)},GameEngine.prototype.die=function(){this.dead||(this.audio.play(this.level.deathMusic,!1,!0,.3),this.dead=!0)},GameEngine.prototype.crush=function(){console.log("death by crushing"),this.die()},GameEngine.prototype.doTick=function t(e){if(e.tickFunctionStopped=!1,e.running){var i=e.level,n=Date.now();for(e.totalDelta+=n-e.lastTick,e.lastTick=n,500<=e.totalDelta&&(e.totalDelta=0);e.totalDelta>=i.physics.timePerTick;)e.tick(e),e.totalDelta-=i.physics.timePerTick;e.renderer.redraw(),e.drawHooks.forEach(function(t){t.call(e.level,e)}),requestAnimationFrame(function(){t(e)})}else e.tickFunctionStopped=!0},GameEngine.prototype.tick=function(t){var e=t.level.physics,i=t.keyboard.keyWasPressed;t.level.tickFunction(t),t.objects.forEach(function(e){if(e.tickFunction&&e.tickFunction.call(e,t),e.bitmap&&e.trigger){var i=t.characterCollision(e.bitmap,e.x,e.y);!i||!e.retrigger&&e.triggered||e.trigger.call(e,t),e.triggered=i}}),t.tickCount++,t.dead||(!i[KEY_LEFT]!=!i[KEY_RIGHT]?(t.isMoving=!0,i[KEY_LEFT]?(t.moveCharacterRight(-e.moveSpeed),t.direction=LEFT):i[KEY_RIGHT]&&(t.moveCharacterRight(e.moveSpeed),t.direction=RIGHT)):t.isMoving=!1,t.fallingState===NOT_FALLING?(i[KEY_JUMP]&&(t.audio.play(t.level.jumpMusic1,!1,!1,.6),t.fallingState=IN_JUMP,t.canJump=!0,t.vspeed=e.jumpInitialSpeed,t.jumpTicks=e.jumpTicks),t.moveCharacterDown(1)||(t.fallingState=FALLING,t.canJump=!0)):(t.fallingState===IN_JUMP?(t.vspeed+=e.jumpGravity,t.jumpTicks--,i[KEY_JUMP]&&0!==t.jumpTicks||(t.fallingState=FALLING)):(t.canJump&&i[KEY_JUMP]&&(t.audio.play(t.level.jumpMusic2,!1,!1,.6),t.fallingState=IN_JUMP,t.canJump=!1,t.vspeed=e.jumpInitialSpeed/1.5,t.jumpTicks=e.jumpTicks),t.vspeed=t.vspeed<e.fallSpeedCap?t.vspeed+e.fallGravity:e.fallSpeedCap),t.moveCharacterDown(Math.roundInfinity(t.vspeed))&&(0<t.vspeed?(t.fallingState=NOT_FALLING,t.vspeed=0,i[KEY_JUMP]=!1):t.vspeed=0)))},GameEngine.prototype.addDrawHook=function(t){this.drawHooks.push(t)},GameEngine.prototype.moveCharacterRight=function(t){if(!this.charBitmap.compareMany(this.blockingObjects,this.posX+t,this.posY))return this.posX+=t,!1;for(var e=Math.sign(t);t;)if(this.posX+=e,t-=e,this.charBitmap.compareMany(this.blockingObjects,this.posX,this.posY))return this.posX-=e,!0;return!1},GameEngine.prototype.moveCharacterDown=function(t){if(!this.charBitmap.compareMany(this.blockingObjects,this.posX,this.posY+t))return this.posY+=t,!1;for(var e=Math.sign(t);t;)if(this.posY+=e,t-=e,this.charBitmap.compareMany(this.blockingObjects,this.posX,this.posY))return this.posY-=e,!0;return!1},GameEngine.prototype.characterCollision=function(t,e,i){return!(e>this.posX+this.level.characterWidth||i>this.posY+this.level.characterHeight||e+t.width<this.posX||i+t.height<this.posY)&&this.charBitmap.compare(t,Math.round(e-this.posX),Math.round(i-this.posY))},GameEngine.prototype.moveObjectRight=function(t,e){var i=Math.sign(e),n=!1;for(this.characterCollision(t.bitmap,t.x,t.y-1)&&(n=!0);e;)e-=i,t.x+=i,n?this.moveCharacterRight(i):this.characterCollision(t.bitmap,t.x,t.y)&&this.moveCharacterRight(i)&&(console.log("crushed"),this.die())},GameEngine.prototype.moveObjectDown=function(t,e){if(0<=e){var i=!1;for(this.characterCollision(t.bitmap,t.x,t.y-1)&&(i=!0);e;)t.y++,e--,i?this.moveCharacterDown(1):this.characterCollision(t.bitmap,t.x,t.y)&&this.moveCharacterDown(1)&&(console.log("crushed"),this.die())}else for(;e;)e++,t.y--,this.characterCollision(t.bitmap,t.x,t.y)&&this.moveCharacterDown(-1)&&(console.log("crushed"),this.die())},AudioManager.prototype.play=function(t,e,i,n,a){if(this.works)if(this.muted)this.playQueue.push([new Date,Array.toArray(arguments)]);else{var o=this.playing.filter(Function.byIndex("file",t)).find(function(t){return(t.audio.ended||t.audio.paused)!=!!i});if(o)var s=o.audio;else s=new Audio(this.path+t),this.playing.push({audio:s,file:t});o=!1,void 0!==a?s.duration&&s.duration<a&&(o=!0):a=0,o||(void 0!==n&&(s.volume=n),4>s.readyState?s.addEventListener("loadedmetadata",function(){s.currentTime=a}):s.currentTime=a,s.loop=e,s.play())}},AudioManager.prototype.preload=function(t,e,i){if(this.works&&!this.muted){if(!this.playing.find(Function.byIndex("file",t))){var n=new Audio(this.path+t);return n.muted=this.muted,e&&(n.addEventListener("canplaythrough",e),i&&n.addEventListener("error",i)),n.load(),this.playing.push({audio:n,file:t}),n}e&&setTimeout(e,0)}else setTimeout(e,0)},AudioManager.prototype.stop=function(t){this.works&&this.playing.filter(Function.byIndex("file",t)).forEach(function(t){t.audio.pause()})},AudioManager.prototype.toggleMute=function(){if(this.works){var t=this.muted=!this.muted;this.playing.forEach(function(e){e.audio.muted=t})}if(!this.muted){var e=this;this.playQueue.forEach(function(t){t[1][4]=(Date.now()-t[0])/1e3,e.play.apply(e,t[1])}),this.playQueue=[]}},Bitmap.fromImage=function(t){var e=t.width,i=t.height,n=new Bitmap(e,i),a=document.createElement("canvas"),o=a.getContext("2d");for(a.width=e,a.height=i,o.clearRect(0,0,e,i),o.drawImage(t,0,0),t=o.getImageData(0,0,e,i).data,e=0;e<n.count;e++)n.data[e]=0<t[4*e+3]|0;return n},Bitmap.prototype.withOtherRect=function(t,e,i,n,a){i=(e=this.getIntersection(t,e,i,n)).otherY*t+e.otherX,n=e.thisY*this.width+e.thisX;for(var o=0;o<e.height;o++){for(var s=0;s<e.width;s++)a(e.otherX+s,e.otherY+o,this.data[n]),i++,n++;i+=t-e.width,n+=this.width-e.width}},Bitmap.prototype.stringify=function(){for(var t="Bitmap  width="+this.width+" height="+this.height+"\n",e=0;e<this.height;e++){for(var i=0;i<this.width;i++)t+=String(this.data[e*this.width+i]);t+="\n"}return t},Bitmap.prototype.set=function(t,e,i){0<=t&&0<=e&&t<this.width&&e<this.height&&(this.data[e*this.width+t]=i)},Bitmap.prototype.copy=function(){return{__proto__:Bitmap.prototype,width:this.width,height:this.height,count:this.count,data:new Uint8Array(this.data)}},Bitmap.prototype.getIntersection=function(t,e,i,n){i=i||0,n=n||0;var a=Math.max(0,i),o=Math.max(0,n);return{thisX:a,thisY:o,otherX:i=Math.max(0,-i),otherY:n=Math.max(0,-n),width:Math.max(0,Math.min(this.width-a,t-i)),height:Math.max(0,Math.min(this.height-o,e-n))}},Bitmap.prototype.slice=function(t,e,i,n){i=this.getIntersection(t,e,i,n),e=new Bitmap(t,e),n=i.thisY*this.width+i.thisX;for(var a=i.otherY*t+i.otherX,o=0;o<i.height;o++){for(var s=0;s<i.width;s++)e.data[a]=this.data[n],n++,a++;n+=this.width-i.width,a+=t-i.width}return e},Bitmap.prototype.isZero=function(){for(var t=0;t<this.count;t++)if(this.data[t])return!1;return!0},Bitmap.prototype.or=function(t,e,i){i=(e=this.getIntersection(t.width,t.height,e,i)).otherY*t.width+e.otherX;for(var n=e.thisY*this.width+e.thisX,a=0;a<e.height;a++){for(var o=0;o<e.width;o++)this.data[n]|=t.data[i],i++,n++;i+=t.width-e.width,n+=this.width-e.width}},Bitmap.prototype.compare=function(t,e,i){i=(e=this.getIntersection(t.width,t.height,e,i)).otherY*t.width+e.otherX;for(var n=e.thisY*this.width+e.thisX,a=0;a<e.height;a++){for(var o=0;o<e.width;o++){if(this.data[n]&&t.data[i])return!0;i++,n++}i+=t.width-e.width,n+=this.width-e.width}return!1},Bitmap.prototype.compareMany=function(t,e,i){var n=this;return t.some(function(t){return!(t.x>e+n.width||t.y>i+n.height||t.x+t.bitmap.width<e||t.y+t.bitmap.height<i)&&n.compare(t.bitmap,t.x-e,t.y-i)})},Line.prototype.getBitmap=function(){if(this.bitmap)return this.bitmap;var t=(this.height-1)/(this.width-1);if(this.bitmap=new Bitmap(this.width,this.height),1<t)for(var e=0;e<this.height;e++)this.bitmap.set(Math.round(e/t),e,1);else for(e=0;e<this.width;e++)this.bitmap.set(e,Math.round(e*t),1);return this.bitmap},Rectangle.prototype.getBitmap=function(){if(this.bitmap)return this.bitmap;this.bitmap=new Bitmap(this.width,this.height);for(var t=0;t<this.bitmap.count;t++)this.bitmap.data[t]=1;return this.bitmap},AutoShape.prototype.getBitmap=function(){return this.bitmap||(this.bitmap=Bitmap.fromImage(this.image)),this.bitmap};var KEY_UP=38,KEY_DOWN=40,KEY_LEFT=37,KEY_RIGHT=39,KEY_JUMP=32,KEY_RESTART=82,KEY_MUTE=77,KEY_SUICIDE=81,KBD_STORAGE_KEY="keyboard_settings";function KeyboardManager(t){this.keysPressed={},this.keyWasPressed={},this.game=t,(t=t.storage.getItem(KBD_STORAGE_KEY))?this.gameKeys=t:this.resetKeys(),window.addEventListener("keydown",this.onkeydown.bind(this),!1),window.addEventListener("keyup",this.onkeyup.bind(this),!1),window.addEventListener("blur",this.onblur.bind(this),!1);var e=this,i=0;document.getElementById("reset_keys").addEventListener("click",function(){this.textContent="Done.;Keys resetted.;You keep failing at this, huh?;undefined;Just kidding.;Bored?;Okay ...;Bisquetti".split(";")[i++],8===i&&(location.href="Why am I bad at videogames?"),e.resetKeys(),e.saveSettings()},!1),[["left",KEY_LEFT],["right",KEY_RIGHT],["jump",KEY_JUMP],["mute",KEY_MUTE],["restart",KEY_RESTART]].forEach(function(t){var i=t[1];t=document.getElementById("change_"+t[0]);var n=document.getElementById("keys"),a=document.getElementById("press_key_msg");t.addEventListener("click",function(){n.style.display="none",a.style.display="block",window.addEventListener("keydown",function t(o){27!==o.which&&(Object.deleteByValue(e.gameKeys,i),e.gameKeys[o.which]=i,e.saveSettings()),window.removeEventListener("keydown",t,!1),n.style.display="block",a.style.display="none",o.preventDefault()},!1)},!1)})}function GameRenderer(t){var e=document.getElementById("canvas");this.context=e.getContext("2d"),e.width=t.width,e.height=t.height,this.canvas=e,this.backgroundCanvas=null,this.animationTick=0,this.animations={},this.game=t}function range(t,e,i){var n=[];for(dbg_assert(0<(i=i||1)),void 0===e&&(e=t,t=0);t<e;t+=i)n.push(t);return n}function dbg_log(t){document.getElementById("debug").textContent=t}function dbg_warn(t){document.getElementById("warn").textContent+=t+"\n"}function dbg_assert(t,e){if(!t)throw console.trace(),"Assert failed: "+e}function http_get(t,e,i){var n=new XMLHttpRequest;return n.onreadystatechange=function(){4===n.readyState&&(200===n.status?e(n.responseText,t):i&&i(n.responseText,n.status))},n.open("get",t,!0),n.send(""),{cancel:function(){n.abort()}}}function cartesianProductOnObjects(t,e){return Object.isArray(t)||(t=[t]),e.reduce(function(t,e){return t.concatMap(function(t){var i=t[e];return Object.isArray(i)?i.map(function(i){var n=Object.deepcopy(t);return n[e]=i,n}):[t]})},t)}KeyboardManager.prototype.resetKeys=function(){this.gameKeys={38:KEY_UP,40:KEY_DOWN,37:KEY_LEFT,39:KEY_RIGHT,32:KEY_JUMP,82:KEY_RESTART,77:KEY_MUTE,81:KEY_SUICIDE}},KeyboardManager.prototype.saveSettings=function(){this.game.storage.setItem(KBD_STORAGE_KEY,this.gameKeys)},KeyboardManager.prototype.isValid=function(t){return!(t.ctrlKey||t.altKey||t.metaKey||t.target instanceof HTMLTextAreaElement||t.target instanceof HTMLInputElement||!this.gameKeys[t.which])},KeyboardManager.prototype.onkeydown=function(t){this.keysPressed[t.which]?t.preventDefault():this.isValid(t)&&(this.keysPressed[t.which]=!0,this.handleKey(!1,t.which),t.preventDefault())},KeyboardManager.prototype.onkeyup=function(t){this.isValid(t)&&(this.keysPressed[t.which]=!1,this.handleKey(!0,t.which),t.preventDefault())},KeyboardManager.prototype.onblur=function(){for(var t=Object.keys(this.keysPressed),e=0;e<t.length;e++){var i=t[e];this.keysPressed[i]&&this.handleKey(!0,Number(i))}this.keysPressed={}},KeyboardManager.prototype.handleKey=function(t,e){(e=this.gameKeys[e])===KEY_MUTE?t||this.game.toggleMute():e===KEY_RESTART&&(t||this.game.restart()),e===KEY_SUICIDE?t||this.game.die():this.keyWasPressed[e]=!t},window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame),GameRenderer.prototype.loadBackground=function(t){this.backgroundCanvas=this.imagesToCanvas(t,this.game.level.width,this.game.level.height,this.game.level.backgroundColor)},GameRenderer.prototype.loadForeground=function(t){this.foregroundCanvas=this.imagesToCanvas(t,this.game.level.width,this.game.level.height)},GameRenderer.prototype.imagesToCanvas=function(t,e,i,n){var a=document.createElement("canvas"),o=a.getContext("2d");return a.width=e,a.height=i,n&&(o.fillStyle=n,o.fillRect(0,0,e,i)),t.forEach(function(t){o.drawImage(t.image,t.x,t.y,t.width,t.height)}),a},GameRenderer.prototype.drawAnimation=function(t,e,i){t=this.game.level.animations[t],this.context.drawImage(this.game.images[t.images[(this.animationTick/t.time|0)%t.images.length]],e,i)},GameRenderer.prototype.drawImageOrAnimation=function(t,e,i){this.game.level.animations[t]?this.drawAnimation(t,e,i):this.context.drawImage(this.game.images[t],e,i)},GameRenderer.prototype.redraw=function(){var t=this.context,e=this.game,i=e.images;if(this.animationTick++,t.drawImage(this.backgroundCanvas,e.viewportX,e.viewportY,e.width,e.height,0,0,e.width,e.height),!e.dead){var n="char";e.fallingState===NOT_FALLING?e.isMoving&&(n+="Moving"):n=0<e.vspeed?n+"Falling":n+"Jumping",n=e.direction==LEFT?n+"Left":n+"Right",this.drawImageOrAnimation(n,e.posX-e.viewportX,e.posY-e.viewportY)}e.drawableObjects.forEach(function(i){i.visible&&i.x+i.width>=e.viewportX&&i.x<e.viewportX+e.width&&i.y+i.height>=e.viewportY&&i.y<e.viewportY+e.height&&t.drawImage(i.image,Math.round(i.x-e.viewportX),Math.round(i.y-e.viewportY),i.width,i.height)}),e.dead&&t.drawImage(i.gameOver,0,150)},GameRenderer.prototype.drawLoadingScreen=function(t,e){this.context.fillStyle="#000",this.context.fillRect(0,0,this.game.width,this.game.height),this.context.fillStyle="#fff",this.context.font="20px monospace",this.context.textAlign="center",this.context.fillText("Loading resources. Please wait ...",this.game.width>>1,100),this.context.fillText(t+" out of "+e,this.game.width>>1,140)},Math.sign=function(t){return(0<t)-(0>t)},Math.roundInfinity=function(t){return 0<t?Math.ceil(t):Math.floor(t)},Math.floatToRandom=function(t){var e=Math.floor(t);return e+(Math.random()>t-e)},Math.triangle=function(t){return function(e){return e/=t,4*Math.abs(e+.25-Math.floor(e+.75))-1}},Math.rectangle=function(t){var e=Math.triangle(t);return function(t){return Math.sign(e(t))}},Math.compare=function(t,e){return Math.sign(t-e)},Array.prototype.findIndex=function(t){var e;return this.some(function(i,n){if(t(i))return e=n,!0}),e},Array.prototype.find=function(t){if(void 0!==(t=this.findIndex(t)))return this[t]},Array.prototype.delete=function(t){return-1!==(t=this.indexOf(t))?this.slice(0,t).concat(this.slice(t+1)):this},Array.prototype.concatMap=function(t){var e=[];return this.forEach(function(i){e=e.concat(t(i))}),e},Array.prototype.deleteList=function(t){return this.filter(function(e){return-1===t.indexOf(e)})},Array.replicate=function(t,e){for(var i=[],n=0;n<t;n++)i[n]=e;return i},Array.prototype.partition=function(t){return this.reduce(function(e,i){return t(i)?e[0].push(i):e[1].push(i),e},[[],[]])},Array.toArray=function(t){return[].slice.call(t)},Function.byIndex=function(t,e){return function(i){return i[t]===e}},Object.deepcopy=function t(e){if("object"==typeof e){if(e instanceof Array)return e.map(t);if(e.__proto__)for(var i={__proto__:e.__proto__},n=Object.keys(e),a=0;a<n.length;a++)i[n[a]]=e[n[a]];else for(n in i={},e)i[n]=t(e[n]);return i}return e},Object.isArray=function(t){return t instanceof Array},Function.not=function(t){return function(e){return!t(e)}},Function.hook=function(t,e,i){var n=t[e];t[e]=function(){n.apply(this,arguments),i.apply(this,arguments)}},Object.extend=function(t,e){for(var i,n=Object.keys(e),a=0;a<n.length;a++)i=n[a],t[i]=e[i];return t},Object.deleteByValue=function(t,e){for(var i=Object.keys(t),n=0;n<i.length;n++)t[i[n]]===e&&delete t[i[n]]},Object.merge=function(t,e){return Object.extend(Object.extend({},t),e)},Object.values=function(t){for(var e=Object.keys(t),i=[],n=0;n<e.length;n++)i.push(t[e[n]]);return i},function(){var t="";window.addEventListener("keyup",function(e){83677278798377==(t=(t+e.which).substr(-14))&&(localStorage.last_level='"2up.js"',localStorage.removeItem("state"),location.reload())},!1)}();